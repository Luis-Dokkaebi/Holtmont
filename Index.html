<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Holtmont Workspace V20</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* VARIABLES Y ESTILOS GLOBALES */
    :root { --sidebar-w: 260px; --primary: #1e1e2d; --accent: #3699ff; --bg-body: #f3f6f9; }
    body { font-family: 'Inter', sans-serif; background: var(--bg-body); margin: 0; overflow: hidden; font-size: 0.9rem; }
    
    /* LOGIN */
    .login-overlay { position: fixed; inset: 0; background: var(--primary); z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .login-card { background: white; padding: 40px; border-radius: 15px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

    /* LAYOUT */
    .app-wrapper { display: flex; height: 100vh; width: 100vw; }
    .sidebar { width: var(--sidebar-w); background: var(--primary); color: #a2a3b7; display: flex; flex-direction: column; z-index: 100; transition: transform 0.3s; }
    .brand { height: 70px; display: flex; align-items: center; padding: 0 25px; font-weight: 700; font-size: 1.3rem; color: white; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .menu { flex: 1; overflow-y: auto; padding: 20px 0; }
    .nav-item { padding: 12px 25px; cursor: pointer; display: flex; align-items: center; transition: 0.2s; font-weight: 500; color: #a2a3b7; }
    .nav-item:hover { color: white; background: rgba(255,255,255,0.03); }
    .nav-item.active { background: #1b1b29; color: var(--accent); border-right: 3px solid var(--accent); }
    .nav-item i { width: 25px; margin-right: 10px; text-align: center; font-size: 1.1rem; }
    .menu-header { padding: 20px 25px 10px; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; color: #5f6275; }

    /* CONTENT */
    .content-wrapper { flex: 1; display: flex; flex-direction: column; background: var(--bg-body); position: relative; }
    .top-bar { height: 70px; background: white; border-bottom: 1px solid #eff2f5; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
    .view-area { flex: 1; overflow-y: auto; padding: 30px; position: relative; }

    /* FORM & UI GENERICO */
    .form-container-pro, .list-container-pro .card { background: white; border-radius: 12px; box-shadow: 0 0 20px 0 rgba(76,87,125,0.02); padding: 40px; max-width: 1000px; margin: 0 auto; }
    .list-container-pro .card { padding: 0; }
    .form-header { margin-bottom: 30px; border-bottom: 1px solid #eff2f5; padding-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .form-label { font-weight: 600; color: #3f4254; margin-bottom: 8px; font-size: 0.9rem; }
    .form-control, .form-select { background-color: #f5f8fa; border: 1px solid #f5f8fa; color: #5e6278; padding: 12px 15px; border-radius: 8px; font-weight: 500; }
    .form-control:focus { background-color: #eef3f7; border-color: #eef3f7; box-shadow: none; color: #3f4254; }
    .btn-submit { background-color: var(--accent); color: white; font-weight: 600; padding: 12px 30px; border-radius: 8px; border: none; transition: 0.3s; }
    
    /* CHIPS & LISTA (PPC) */
    .chip-container { border: 1px solid #f5f8fa; background-color: #f5f8fa; border-radius: 8px; padding: 5px 10px; display: flex; flex-wrap: wrap; gap: 5px; align-items: center; min-height: 48px; position: relative; }
    .chip-container:focus-within { background-color: #eef3f7; border-color: #eef3f7; }
    .user-chip { background-color: white; border: 1px solid #e1e3ea; border-radius: 50px; padding: 4px 10px 4px 4px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; font-weight: 600; color: #3f4254; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .user-chip .avatar { width: 24px; height: 24px; background-color: var(--accent); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.7rem; }
    .user-chip .btn-remove { color: #b5b5c3; cursor: pointer; font-size: 1rem; line-height: 1; margin-left: 5px; }
    .user-chip .btn-remove:hover { color: #f1416c; }
    .chip-input { border: none; outline: none; background: transparent; flex: 1; min-width: 150px; padding: 5px; font-size: 0.9rem; color: #5e6278; }
    .suggestions-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-top: 5px; max-height: 200px; overflow-y: auto; z-index: 1000; list-style: none; padding: 0; border: 1px solid #eff2f5; }
    .suggestion-item { padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; border-bottom: 1px solid #f9f9f9; }
    .suggestion-item:hover { background-color: #f1faff; color: var(--accent); }
    .suggestion-item .initials { width: 30px; height: 30px; background: #eef3f7; color: #7e8299; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 0.8rem; }

    /* PRIORIDAD (PÍLDORAS) */
    .priority-group { display: flex; background: #f5f8fa; padding: 5px; border-radius: 50px; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
    .priority-option { padding: 8px 15px; border-radius: 50px; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: #a1a5b7; transition: 0.2s; }
    .priority-option.active.urgente { background: #f1416c; color: white; }
    .priority-option.active.media { background: #ffc700; color: #3f4254; }
    .priority-option.active.baja { background: #50cd89; color: white; }
    .priority-option.active.bajo { background: #50cd89; color: white; }
    .priority-option.active.medio { background: #ffc700; color: #3f4254; }
    .priority-option.active.alto { background: #f1416c; color: white; }
    .priority-option.active.catastrofico { background: #7239ea; color: white; }

    /* DROP ZONE */
    .drop-zone { border: 2px dashed #d1d5db; border-radius: 8px; background: #f9fafb; padding: 25px; text-align: center; cursor: pointer; transition: 0.2s; position: relative; }
    .drop-zone:hover, .drop-zone.dragover { border-color: var(--accent); background: #f0f7ff; }
    .drop-zone i { font-size: 2rem; color: #9ca3af; margin-bottom: 10px; }
    .file-input-hidden { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; }
    .uploading-state { color: var(--accent); font-weight: 600; }
    .upload-success { color: #10b981; font-weight: 600; }

    /* UTILS ADICIONALES */
    .dept-card { background: white; border-radius: 12px; box-shadow: 0 0 20px 0 rgba(0,0,0,0.03); cursor: pointer; transition: 0.3s; border-top: 4px solid transparent; height: 100%; padding: 20px; text-align: center;}
    .dept-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .staff-card { background: white; border-radius: 10px; padding: 20px; border: 1px solid #f0f0f0; text-align: center; transition: 0.2s; }
    .staff-card:hover { border-color: var(--accent); box-shadow: 0 5px 15px rgba(54,153,255,0.1); }
    .iframe-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: white; display: flex; flex-direction: column; }
    .iframe-toolbar { height: 50px; background: #212529; color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
    iframe { flex: 1; width: 100%; border: none; }
    .tab-bar { background: #f8f9fa; border-bottom: 1px solid #dee2e6; padding: 10px 10px 0; display: flex; gap: 5px; flex-wrap: wrap; }
    .tab-btn { padding: 8px 15px; border: none; background: transparent; cursor: pointer; font-weight: 500; color: #6c757d; border-radius: 5px 5px 0 0; }
    .tab-btn:hover { background: #e9ecef; }
    .tab-btn.active { background: white; color: var(--primary); font-weight: 700; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
    
    /* TABLAS NATIVAS EDITABLES (CRÍTICO) */
    .table-native th { background-color: #f0f2f5; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; vertical-align: middle; color: #5e6278; font-weight: 700; white-space: nowrap; }
    .table-native td { vertical-align: middle; padding: 0.25rem 0.5rem; }
    .table-native input, .table-native select, .table-native textarea { border: 1px solid transparent; background: transparent; font-size: 0.85rem; width: 100%; color: #3f4254; padding: 4px; border-radius: 4px; }
    .table-native input:focus, .table-native select:focus, .table-native textarea:focus { border-color: var(--accent); background: white; outline: none; box-shadow: 0 0 0 2px rgba(54,153,255,0.1); }
    .table-native tr:hover { background-color: #f9f9f9; }
    .table-native tr:hover input { background-color: white; border-color: #e4e6ef; }
  </style>
</head>
<body>

<div id="app" v-cloak>
  
  <div v-if="!isLoggedIn" class="login-overlay">
    <div class="login-card">
      <h3 class="fw-bold mb-4 text-dark"><i class="fas fa-layer-group text-primary me-2"></i> HOLTMONT</h3>
      <p class="text-muted mb-4">Ingreso Seguro V20</p>
      <input type="password" v-model="loginPass" class="form-control form-control-lg text-center mb-3" placeholder="Contraseña..." @keyup.enter="doLogin">
      <button class="btn btn-primary w-100 py-2 fw-bold" @click="doLogin" :disabled="loggingIn">
        <span v-if="loggingIn"><i class="fas fa-spinner fa-spin"></i> Entrando...</span>
        <span v-else>Ingresar</span>
      </button>
    </div>
  </div>

  <div v-if="isLoggedIn" class="app-wrapper">
    
    <aside class="sidebar" :class="{ open: sidebarOpen }">
      <div class="brand"><i class="fas fa-layer-group me-2 text-primary"></i> HOLTMONT</div>
      <div class="menu">
        <div class="nav-item" :class="{ active: currentView === 'DASHBOARD' }" @click="goHome"><i class="fas fa-home"></i> Inicio</div>
        
        <div v-if="config.specialModules && config.specialModules.length > 0">
          <div class="menu-header">Módulos</div>
          <div class="nav-item" v-for="mod in config.specialModules" :class="{ active: currentModuleId === mod.id }" @click="openModule(mod)">
            <i class="fas" :class="mod.icon" :style="{ color: mod.color }"></i> {{ mod.label }}
          </div>
        </div>

        <div v-if="Object.keys(config.departments).length > 0">
          <div class="menu-header">Departamentos</div>
          <div class="nav-item" v-for="(dept, key) in config.departments" :class="{ active: currentView === 'DEPT' && currentDept === key }" @click="selectDept(key)">
            <i class="fas" :class="dept.icon"></i> {{ dept.label }}
          </div>
        </div>
        
        <div class="mt-auto p-3">
             <button class="btn btn-outline-secondary btn-sm w-100" @click="logout"><i class="fas fa-sign-out-alt me-2"></i> Salir</button>
        </div>
      </div>
    </aside>

    <main class="content-wrapper">
      <div class="top-bar">
        <button class="btn btn-sm d-md-none" @click="sidebarOpen = !sidebarOpen"><i class="fas fa-bars"></i></button>
        <h5 class="m-0 fw-bold text-dark">{{ pageTitle }}</h5>
        <div><span class="badge bg-light text-dark border px-3 py-2"><i class="fas fa-user me-2"></i> {{ currentUser }}</span></div>
      </div>

      <div class="view-area" v-if="!['IFRAME', 'MODULE_TABS'].includes(currentView)">
        
        <div v-if="currentView === 'DASHBOARD'" class="row g-4">
          <div class="col-md-4 col-xl-3" v-for="mod in config.specialModules">
            <div class="dept-card" @click="openModule(mod)" :style="{ borderTopColor: mod.color }">
              <i class="fas fa-2x mb-3" :class="mod.icon" :style="{ color: mod.color }"></i>
              <h5 class="fw-bold">{{ mod.label }}</h5>
            </div>
          </div>
          <div class="col-md-4 col-xl-3" v-for="(dept, key) in config.departments">
            <div class="dept-card" @click="selectDept(key)" :style="{ borderTopColor: dept.color }">
              <i class="fas fa-2x mb-3" :class="dept.icon" :style="{ color: dept.color }"></i>
              <h5 class="fw-bold">{{ dept.label }}</h5>
            </div>
          </div>
        </div>

        <div v-if="currentView === 'PPC_FORM'">
          <div class="d-flex justify-content-end gap-3 mb-4">
            <button v-if="ppcViewMode === 'FORM'" class="btn btn-outline-primary px-4" @click="ppcViewMode = 'LIST'; fetchPPCData();"><i class="fas fa-list me-2"></i> Ver Panel</button>
            <button v-else class="btn btn-outline-primary px-4" @click="ppcViewMode = 'FORM'"><i class="fas fa-edit me-2"></i> Registrar Actividad</button>
          </div>

          <div v-if="ppcViewMode === 'FORM'" class="form-container-pro">
            <div class="form-header">
              <h3><i class="fas fa-edit text-primary me-2"></i> Registrar Actividad</h3>
              <button class="btn btn-light btn-sm" @click="goHome"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="row g-4">
              <div class="col-md-4">
                <label class="form-label">Especialidad</label>
                <select v-model="ppcData.especialidad" class="form-select">
                  <option value="" disabled>Seleccione...</option>
                  <option>CONSTRUCCION</option><option>HVAC</option><option>ELECTROMECANICA</option>
                  <option>EHS</option><option>COMPRAS</option><option>DISEÑO</option><option>ADMINISTRACION</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Clasificación <i class="fas fa-info-circle text-muted" title="A=3 días, AA=15 días, AAA=30 días"></i></label>
                <select v-model="ppcData.clasificacion" class="form-select">
                  <option value="" disabled>Seleccione...</option>
                  <option value="A">A (3 Días)</option>
                  <option value="AA">AA (15 Días)</option>
                  <option value="AAA">AAA (30 Días)</option>
                </select>
              </div>

              <div class="col-md-4 position-relative">
                <label class="form-label">Responsable(s)</label>
                <div class="chip-container" @click="$refs.chipInput.focus()">
                  <div class="user-chip" v-for="(user, index) in selectedResponsables" :key="index">
                    <div class="avatar">{{ user.charAt(0) }}</div>{{ user }}<span class="btn-remove" @click.stop="removeResponsable(index)">&times;</span>
                  </div>
                  <input ref="chipInput" v-model="staffSearch" @focus="showSuggestions = true" @blur="setTimeout(() => showSuggestions = false, 200)" class="chip-input" placeholder="Buscar..." @keydown.enter.prevent="addFirstSuggestion">
                </div>
                <ul class="suggestions-list" v-if="showSuggestions && filteredStaffList.length > 0">
                  <li v-for="person in filteredStaffList" class="suggestion-item" @click="addResponsable(person.name)">
                    <div class="initials">{{ person.name.charAt(0) }}</div>
                    <div><div class="fw-bold">{{ person.name }}</div><small class="text-muted">{{ person.dept }}</small></div>
                  </li>
                </ul>
              </div>

              <div class="col-12">
                <label class="form-label">Descripción de la Actividad</label>
                <textarea v-model="ppcData.concepto" class="form-control" rows="2" placeholder="Detalle de la tarea..."></textarea>
              </div>
              
              <div class="col-12">
                <label class="form-label">Riesgos</label>
                <div class="priority-group">
                    <div class="priority-option" :class="{ 'active bajo': ppcData.riesgos === 'Bajo' }" @click="ppcData.riesgos = 'Bajo'">Bajo</div>
                    <div class="priority-option" :class="{ 'active medio': ppcData.riesgos === 'Medio' }" @click="ppcData.riesgos = 'Medio'">Medio</div>
                    <div class="priority-option" :class="{ 'active alto': ppcData.riesgos === 'Alto' }" @click="ppcData.riesgos = 'Alto'">Alto</div>
                    <div class="priority-option" :class="{ 'active catastrofico': ppcData.riesgos === 'Catastrófico' }" @click="ppcData.riesgos = 'Catastrófico'">Catastrófico</div>
                </div>
              </div>

              <div class="col-md-3">
                <label class="form-label">Hora Finalización</label>
                <input type="time" v-model="ppcData.horaFin" class="form-control">
              </div>
              <div class="col-md-2">
                <label class="form-label">Reloj (Hrs)</label>
                <input type="text" v-model="ppcData.horas" class="form-control" placeholder="Ej: 24">
              </div>
              
              <div class="col-md-7">
                <label class="form-label">Prioridad</label>
                <div class="priority-group">
                  <div class="priority-option" :class="{ 'active urgente': ppcData.prioridad === 'Urgente' }" @click="ppcData.prioridad = 'Urgente'">Urgente</div>
                  <div class="priority-option" :class="{ 'active media': ppcData.prioridad === 'Media' }" @click="ppcData.prioridad = 'Media'">Media</div>
                  <div class="priority-option" :class="{ 'active baja': ppcData.prioridad === 'Baja' }" @click="ppcData.prioridad = 'Baja'">Baja</div>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Adjuntar Archivo</label>
                <div class="drop-zone" 
                      @dragover.prevent="dragOver = true" @dragleave.prevent="dragOver = false" @drop.prevent="handleDrop"
                      :class="{ 'dragover': dragOver, 'upload-success': uploadSuccess }">
                  <div v-if="isUploadingFile" class="uploading-state"><div class="spinner-border spinner-border-sm text-primary"></div> Subiendo...</div>
                  <div v-else-if="uploadSuccess" class="upload-success"><i class="fas fa-check-circle"></i> Listo</div>
                  <div v-else><i class="fas fa-cloud-upload-alt"></i> <p>Arrastra aquí</p></div>
                  <input type="file" class="file-input-hidden" @change="handleFileSelect">
                </div>
                <input type="hidden" v-model="ppcData.archivoUrl">
              </div>

              <div class="col-md-6">
                <label class="form-label">Comentarios</label>
                <textarea v-model="ppcData.comentarios" class="form-control" rows="3" placeholder="Notas adicionales..."></textarea>
              </div>
            </div>

            <div class="d-flex justify-content-end mt-5 pt-3 border-top">
              <button class="btn btn-light me-2" @click="goHome">Cancelar</button>
              <button class="btn btn-submit" @click="submitPPC" :disabled="isSubmitting">
                <span v-if="isSubmitting"><i class="fas fa-spinner fa-spin me-2"></i> Guardando...</span>
                <span v-else><i class="fas fa-save me-2"></i> Guardar Registro</span>
              </button>
            </div>
          </div>

          <div v-else class="list-container-pro">
            <div class="card shadow-sm">
              <div class="card-header bg-white fw-bold"><i class="fas fa-clipboard-list me-2"></i> Panel de Actividades PPC ({{ fetchedPPCData.length }})</div>
              <div class="card-body p-0">
                <div v-if="isFetchingPPC" class="text-center p-5"><div class="spinner-border text-primary" style="width: 2rem; height: 2rem;"></div><p class="mt-3 text-muted">Cargando actividades...</p></div>
                <div v-else-if="fetchedPPCData.length === 0" class="alert alert-info m-4">No hay actividades registradas.</div>
                <div v-else class="table-responsive" style="max-height: 70vh;">
                  <table class="table table-striped table-sm mb-0">
                    <thead class="bg-light sticky-top">
                      <tr>
                        <th>ID</th><th>Esp.</th><th>Concepto</th><th>Responsable(s)</th><th>Fecha Alta</th><th>Horas</th><th>Clasif.</th><th>Prioridad</th><th>Cumpl.</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="item in fetchedPPCData" :key="item.id">
                        <td><span class="badge bg-primary">{{ item.id }}</span></td>
                        <td>{{ item.especialidad }}</td>
                        <td class="text-truncate" style="max-width: 250px;" :title="item.concepto">{{ item.concepto }}</td>
                        <td>{{ item.responsable }}</td>
                        <td>{{ item.fechaAlta }}</td>
                        <td>{{ item.horas }}</td>
                        <td><span class="badge bg-secondary">{{ item.clasificacion }}</span></td>
                        <td>
                            <span class="badge" 
                                :class="{
                                    'bg-danger': item.prioridad === 'Urgente' || item.prioridad === 'Catastrófica', 
                                    'bg-warning text-dark': item.prioridad === 'Media', 
                                    'bg-success': item.prioridad === 'Baja'
                                }">{{ item.prioridad }}</span>
                        </td>
                        <td><i class="fas" :class="{'fa-check-circle text-success': item.cumplimiento === 'SI', 'fa-times-circle text-danger': item.cumplimiento === 'NO'}"></i></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div v-if="currentView === 'DEPT'">
          <div class="d-flex justify-content-between mb-4">
            <button class="btn btn-light border" @click="goHome"><i class="fas fa-arrow-left"></i> Volver</button>
            <input type="text" v-model="searchQuery" class="form-control w-auto" placeholder="Buscar personal...">
          </div>
          <div class="row g-3">
            <div class="col-md-4 col-lg-3" v-for="p in filteredStaff">
              <div class="staff-card h-100" @click="openStaffTracker(p)">
                <div class="avatar-circle mb-3 mx-auto bg-light text-primary fw-bold d-flex align-items-center justify-content-center" style="width:60px;height:60px;border-radius:50%;font-size:1.5rem">
                    {{ p.name.charAt(0) }}
                </div>
                <h6 class="fw-bold text-dark">{{ p.name }}</h6>
                <small class="text-muted">{{ p.dept }}</small>
                <button class="btn btn-sm w-100 mt-3 text-white" :style="{ backgroundColor: currentDeptData.color }">
                  <i class="fas fa-eye me-1"></i> Abrir Tracker
                </button>
              </div>
            </div>
          </div>
        </div>

        <div v-if="currentView === 'STAFF_TRACKER'" class="h-100 d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-sm btn-light border" @click="goBackToDept"><i class="fas fa-arrow-left"></i> Volver</button>
            <div>
                <button class="btn btn-primary btn-sm me-2" @click="openModule({id: 'PPC_MASTER', label: 'Panel PPC', type: 'ppc_native'})"><i class="fas fa-plus"></i> Nueva Tarea</button>
                <button class="btn btn-sm btn-success me-2" @click="reloadStaffTracker"><i class="fas fa-sync"></i> Recargar Datos</button>
                <span class="badge bg-warning text-dark">Modo Edición Activo</span>
            </div>
          </div>

          <div class="card shadow-sm flex-fill overflow-hidden d-flex flex-column">
            <div class="card-body p-0 table-responsive">
              <div v-if="staffTracker.isLoading" class="text-center p-5">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2 text-muted">Cargando hoja nativa del empleado...</p>
              </div>
              <div v-else-if="staffTracker.data.length === 0" class="p-5 text-center text-muted">
                <p>No hay datos o no se detectó la tabla.</p>
                <small class="text-danger" v-if="staffTracker.message">{{ staffTracker.message }}</small>
              </div>
              <table v-else class="table table-native table-bordered mb-0">
                <thead class="sticky-top border-bottom bg-light">
                  <tr>
                    <th style="width: 50px;">Acción</th>
                    <th style="width: 80px;">Folio</th>
                    <th style="width: 100px;">Alta</th>
                    <th style="width: 90px;">Fecha</th>
                    <th style="width: 70px;">Hora</th>
                    <th style="width: 100px;">Clasif.</th>
                    <th style="min-width: 250px;">Concepto</th>
                    <th style="width: 150px;">Involucrados</th>
                    <th style="width: 80px;">Avance %</th>
                    <th style="width: 100px;">Est. Fin</th>
                    <th style="width: 80px;">Reloj</th>
                    <th style="width: 150px;">Restricciones</th>
                    <th style="width: 100px;">Prioridad</th>
                    <th style="width: 100px;">Riesgos</th>
                    <th style="width: 100px;">Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(task, index) in staffTracker.data" :key="task.id">
                    <td class="text-center bg-light">
                        <button class="btn btn-sm btn-primary" title="Guardar cambios de esta fila" @click="saveRow(task)">
                            <i class="fas fa-save"></i>
                        </button>
                    </td>
                    <td><input v-model="task.id" readonly class="fw-bold text-muted bg-light"></td>
                    <td><input v-model="task.alta"></td>
                    <td><input v-model="task.fecha" placeholder="DD/MM/YYYY"></td>
                    <td><input v-model="task.hora"></td>
                    <td>
                        <select v-model="task.clasificacion">
                            <option value="">-</option>
                            <option value="A">A</option>
                            <option value="AA">AA</option>
                            <option value="AAA">AAA</option>
                        </select>
                    </td>
                    <td><textarea v-model="task.concepto" rows="1" style="min-height: 28px; resize: vertical;"></textarea></td>
                    <td><input v-model="task.involucrados"></td>
                    <td><input v-model="task.avance"></td>
                    <td><input v-model="task.fechaEstFin"></td>
                    <td><input v-model="task.reloj"></td>
                    <td><textarea v-model="task.restricciones" rows="1"></textarea></td>
                    <td>
                        <select v-model="task.prioridades">
                            <option value="Baja">Baja</option>
                            <option value="Media">Media</option>
                            <option value="Urgente">Urgente</option>
                        </select>
                    </td>
                    <td>
                        <select v-model="task.riesgos">
                            <option value="Bajo">Bajo</option>
                            <option value="Medio">Medio</option>
                            <option value="Alto">Alto</option>
                            <option value="Catastrófico">Catastrófico</option>
                        </select>
                    </td>
                    <td><input v-model="task.status"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div v-if="currentView === 'SALES_CRUD'" class="card shadow-sm border-0">
          <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold text-danger"><i class="fas fa-chart-line me-2"></i> Control de Ventas</h5>
            <div>
               <button class="btn btn-sm btn-outline-secondary me-2" @click="fetchSalesData"><i class="fas fa-sync"></i> Recargar</button>
               <button class="btn btn-sm btn-danger" @click="showSalesModal = true"><i class="fas fa-plus"></i> Nueva Venta</button>
            </div>
          </div>
          <div class="card-body p-0">
            <div v-if="salesLoading" class="text-center p-5"><div class="spinner-border text-danger"></div></div>
            <div v-else-if="salesData.length === 0" class="text-center p-5 text-muted">No hay registros o no se ha configurado el ID de la hoja.</div>
            <div v-else class="table-responsive" style="max-height: 75vh;">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-dark sticky-top">
                        <tr>
                            <th v-for="h in salesHeaders">{{ h }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="row in salesData">
                            <td v-for="h in salesHeaders">{{ row[h] }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
          </div>

          <div v-if="showSalesModal" class="modal d-block" style="background: rgba(0,0,0,0.5)">
              <div class="modal-dialog">
                  <div class="modal-content">
                      <div class="modal-header">
                          <h5 class="modal-title">Registrar Venta</h5>
                          <button type="button" class="btn-close" @click="showSalesModal = false"></button>
                      </div>
                      <div class="modal-body">
                          <p class="text-muted small">Los campos se generan dinámicamente basados en las columnas de tu hoja.</p>
                          <div class="mb-2" v-for="h in salesHeaders" :key="h">
                              <label class="form-label small fw-bold">{{h}}</label>
                              <input type="text" class="form-control" v-model="newSaleData[h]">
                          </div>
                      </div>
                      <div class="modal-footer">
                          <button class="btn btn-secondary" @click="showSalesModal = false">Cancelar</button>
                          <button class="btn btn-danger" @click="submitSale">Guardar</button>
                      </div>
                  </div>
              </div>
          </div>
        </div>

      </div>

      <div v-if="['IFRAME', 'MODULE_TABS'].includes(currentView)" class="iframe-container">
        <div class="iframe-toolbar">
          <span class="fw-bold"><i class="fas fa-desktop me-2"></i> {{ iframeTitle }}</span>
          <button class="btn btn-sm btn-danger" @click="closeIframe"><i class="fas fa-times"></i> Cerrar</button>
        </div>
        <div v-if="currentView === 'MODULE_TABS'" class="tab-bar">
          <button v-for="tab in activeModuleTabs" class="tab-btn" :class="{ active: currentIframeUrl === tab.url }" @click="currentIframeUrl = tab.url">
            {{ tab.name }}
          </button>
        </div>
        <iframe :src="currentIframeUrl"></iframe>
      </div>
    </main>
  </div>
</div>

<script>
  const { createApp, ref, computed, onMounted } = Vue;

  createApp({
    setup() {
      // ESTADO AUTH
      const isLoggedIn = ref(false);
      const loginPass = ref('');
      const loggingIn = ref(false);
      const currentUser = ref('');
      const userRole = ref('');

      // ESTADO GLOBAL
      const sidebarOpen = ref(false);
      const currentView = ref('DASHBOARD');
      const currentDept = ref('');
      const currentModuleId = ref('');
      const currentIframeUrl = ref('');
      const iframeTitle = ref('');
      const searchQuery = ref('');
      const activeModuleTabs = ref([]);
      const config = ref({ departments: {}, staff: [], specialModules: [] });
      
      // ESTADO PPC
      const ppcViewMode = ref('FORM');
      const isFetchingPPC = ref(false);
      const fetchedPPCData = ref([]);
      const ppcData = ref({ especialidad: '', concepto: '', horas: '', horaFin: '', clasificacion: '', riesgos: '', prioridad: 'Media', cumplimiento: 'NO', archivoUrl: '', comentarios: '', comentariosPrevios: '' });
      const isSubmitting = ref(false);
      const selectedResponsables = ref([]);
      const staffSearch = ref('');
      const showSuggestions = ref(false);
      const dragOver = ref(false);
      const isUploadingFile = ref(false);
      const uploadSuccess = ref(false);

      // ESTADO TRACKER
      const staffTracker = ref({ name: '', data: [], isLoading: false, previousView: 'DEPT', message: '' }); 

      // ESTADO VENTAS
      const salesData = ref([]);
      const salesHeaders = ref([]);
      const salesLoading = ref(false);
      const showSalesModal = ref(false);
      const newSaleData = ref({});

      // AUTH & INIT
      const doLogin = () => {
          if(!loginPass.value) return;
          loggingIn.value = true;
          google.script.run.withSuccessHandler(res => {
              loggingIn.value = false;
              if (res.success) {
                  isLoggedIn.value = true;
                  currentUser.value = res.name;
                  userRole.value = res.role;
                  loadConfig(res.role);
              } else {
                  Swal.fire('Error', res.message, 'error');
              }
          }).apiLogin(loginPass.value);
      };

      const loadConfig = (role) => {
          google.script.run.withSuccessHandler(data => {
              config.value = data;
              if (role === 'SALES') openModule(data.specialModules[0]);
          }).getSystemConfig(role);
      };

      const logout = () => {
          isLoggedIn.value = false;
          loginPass.value = '';
          currentView.value = 'DASHBOARD';
      };

      // NAVEGACION
      const goHome = () => { currentView.value = 'DASHBOARD'; sidebarOpen.value = false; currentModuleId.value = ''; };
      const selectDept = (key) => { currentDept.value = key; currentView.value = 'DEPT'; searchQuery.value = ''; sidebarOpen.value = false; currentModuleId.value = ''; };

      const openModule = (mod) => {
        iframeTitle.value = mod.label; currentModuleId.value = mod.id;
        if (mod.type === 'ppc_native') { currentView.value = 'PPC_FORM'; ppcViewMode.value = 'FORM'; }
        else if (mod.type === 'sales_native') { currentView.value = 'SALES_CRUD'; fetchSalesData(); }
        else if (mod.type === 'tabs') { activeModuleTabs.value = mod.tabs; currentIframeUrl.value = mod.tabs[0].url; currentView.value = 'MODULE_TABS'; }
        else { currentIframeUrl.value = mod.url; currentView.value = 'IFRAME'; }
        sidebarOpen.value = false;
      };

      const closeIframe = () => { 
        if (currentView.value === 'IFRAME' || currentView.value === 'MODULE_TABS') {
            const mod = config.value.specialModules.find(m => m.id === currentModuleId.value);
            if (mod && mod.id !== 'PPC_MASTER') goHome();
        }
        if (currentDept.value) currentView.value = 'DEPT'; else goHome();
      };

      // LOGICA PPC
      const fetchPPCData = () => { 
        if (fetchedPPCData.value.length > 0 && isFetchingPPC.value === false) return;
        isFetchingPPC.value = true;
        google.script.run.withSuccessHandler(res => {
            isFetchingPPC.value = false;
            if(res.success) fetchedPPCData.value = res.data.reverse();
            else Swal.fire('Error al cargar', res.message, 'error');
        }).apiFetchPPCData();
      };

      const submitPPC = () => {
        if(selectedResponsables.value.length === 0 || !ppcData.value.concepto) return Swal.fire('Atención', 'Asigne responsable y concepto.', 'warning');
        isSubmitting.value = true;
        const payload = JSON.parse(JSON.stringify(ppcData.value));
        payload.responsable = selectedResponsables.value.join(', ');
        google.script.run.withSuccessHandler(res => {
          isSubmitting.value = false;
          if(res.success) {
            Swal.fire('Guardado', res.message, 'success');
            ppcData.value = { especialidad: '', concepto: '', horas: '', horaFin: '', clasificacion: '', riesgos: '', prioridad: 'Media', cumplimiento: 'NO', archivoUrl: '', comentarios: '', comentariosPrevios: '' };
            selectedResponsables.value = [];
            uploadSuccess.value = false;
          } else { Swal.fire('Error', res.message, 'error'); }
        }).apiSavePPCData(payload);
      };

      // STAFF TRACKER (MODIFICADO PARA EDICION)
      const openStaffTracker = (person) => {
          staffTracker.value.name = person.name;
          staffTracker.value.previousView = currentView.value;
          currentView.value = 'STAFF_TRACKER';
          iframeTitle.value = `Tracker de ${person.name}`;
          loadStaffTrackerData(person.name);
      };

      const loadStaffTrackerData = (personName) => {
          staffTracker.value.isLoading = true;
          staffTracker.value.data = [];
          staffTracker.value.message = '';
          google.script.run.withSuccessHandler(res => {
                  staffTracker.value.isLoading = false;
                  if (res.success) {
                    staffTracker.value.data = res.data;
                    if(res.data.length === 0) staffTracker.value.message = res.message || 'Sin datos';
                  }
                  else {
                    Swal.fire('Error', res.message, 'error');
                    staffTracker.value.message = res.message;
                  }
          }).apiFetchStaffTrackerData(personName);
      };
      
      const reloadStaffTracker = () => { if (staffTracker.value.name) loadStaffTrackerData(staffTracker.value.name); };
      const goBackToDept = () => { currentView.value = staffTracker.value.previousView; };

      const saveRow = (task) => {
        const taskPayload = JSON.parse(JSON.stringify(task));
        const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 3000});
        Swal.fire({title: 'Guardando...', didOpen: () => Swal.showLoading()});
        
        google.script.run.withSuccessHandler(res => {
            Swal.close();
            if(res.success) {
                Toast.fire({ icon: 'success', title: 'Fila actualizada' });
            } else {
                Swal.fire('Error', res.message, 'error');
            }
        }).apiUpdateTask(staffTracker.value.name, taskPayload);
      };

      // VENTAS (ANTONIA)
      const fetchSalesData = () => {
          salesLoading.value = true;
          google.script.run.withSuccessHandler(res => {
              salesLoading.value = false;
              if(res.success) {
                  salesData.value = res.data;
                  salesHeaders.value = res.headers || [];
              }
          }).apiFetchSalesData();
      };
      const submitSale = () => {
          google.script.run.withSuccessHandler(res => {
             if(res.success) {
                 Swal.fire('Guardado', 'Registro exitoso', 'success');
                 showSalesModal.value = false;
                 newSaleData.value = {};
                 fetchSalesData();
             } else {
                 Swal.fire('Error', res.message, 'error');
             }
          }).apiSaveSaleData(JSON.parse(JSON.stringify(newSaleData.value)));
      };

      // HELPERS
      const filteredStaffList = computed(() => {
        const term = staffSearch.value.toLowerCase();
        return config.value.staff.filter(p => {
          const matchName = p.name.toLowerCase().includes(term);
          const notSelected = !selectedResponsables.value.includes(p.name);
          return matchName && notSelected;
        }).slice(0, 5);
      });
      const addResponsable = (name) => { selectedResponsables.value.push(name); staffSearch.value = ''; showSuggestions.value = false; };
      const removeResponsable = (index) => { selectedResponsables.value.splice(index, 1); };
      const addFirstSuggestion = () => { if (filteredStaffList.value.length > 0) addResponsable(filteredStaffList.value[0].name); };
      
      const handleFile = (file) => {
        isUploadingFile.value = true;
        uploadSuccess.value = false;
        ppcData.value.archivoUrl = '';
        const reader = new FileReader();
        reader.onload = (e) => {
          google.script.run.withSuccessHandler(res => {
                  isUploadingFile.value = false;
                  if(res.success) { 
                      uploadSuccess.value = true; 
                      ppcData.value.archivoUrl = res.fileUrl; 
                      Swal.fire({ title: 'Subida Exitosa!', icon: 'success', toast: true, position: 'top-end', showConfirmButton: false, timer: 4000 });
                  } else { 
                      Swal.fire('Error', res.message, 'error'); 
                      uploadSuccess.value = false;
                  }
              }).uploadFileToDrive(e.target.result, 'doc', file.name);
        };
        reader.readAsDataURL(file);
      };
      const handleDrop = (e) => { dragOver.value = false; if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); };
      const handleFileSelect = (e) => { if(e.target.files.length) handleFile(e.target.files[0]); };

      const currentDeptData = computed(() => config.value.departments[currentDept.value] || {});
      const pageTitle = computed(() => {
        if (currentView.value === 'DASHBOARD') return 'Panel de Control';
        if (currentView.value === 'PPC_FORM') return 'Gestión PPC';
        if (currentView.value === 'SALES_CRUD') return 'Gestión de Ventas';
        if (currentView.value === 'DEPT') return currentDeptData.value.label;
        if (currentView.value === 'STAFF_TRACKER') return `Tracker: ${staffTracker.value.name}`;
        return iframeTitle.value;
      });
      const filteredStaff = computed(() => {
        if (currentView.value !== 'DEPT') return [];
        return config.value.staff.filter(p => p.dept === currentDept.value && p.name.toLowerCase().includes(searchQuery.value.toLowerCase()));
      });

      return {
        isLoggedIn, loginPass, loggingIn, doLogin, logout, currentUser,
        sidebarOpen, currentView, currentDept, currentModuleId, config,
        currentIframeUrl, iframeTitle, searchQuery, activeModuleTabs, 
        ppcData, selectedResponsables, staffSearch, showSuggestions, filteredStaffList,
        dragOver, isUploadingFile, uploadSuccess, isSubmitting,
        ppcViewMode, isFetchingPPC, fetchedPPCData, 
        staffTracker, salesData, salesHeaders, salesLoading, showSalesModal, newSaleData,
        goHome, selectDept, openModule, closeIframe, 
        submitPPC, fetchPPCData,
        openStaffTracker, goBackToDept, reloadStaffTracker, saveRow,
        fetchSalesData, submitSale,
        addResponsable, removeResponsable, addFirstSuggestion, handleDrop, handleFileSelect,
        currentDeptData, pageTitle, filteredStaff
      };
    }
  }).mount('#app');
</script>
</body>
</html>
