<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Holtmont V111</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root { --sidebar-w: 260px; --primary: #1c1c1c; --accent: #3699ff; --bg-body: #f3f6f9; }
    body { font-family: 'Roboto', sans-serif; background: var(--bg-body); margin: 0; overflow: hidden; font-size: 13px; }
    
    .content-wrapper { flex: 1; display: flex; flex-direction: column; background: var(--bg-body); overflow: hidden; position: relative; }
    .view-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 20px; width: 100%; box-sizing: border-box; }

    /* TABLA EXCEL GENÉRICA */
    .excel-container { 
        flex: 1; overflow: auto; background: white; border: 1px solid #999; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); width: 100%;
        scrollbar-width: thin; scrollbar-color: #a0a0a0 #f1f1f1;
    }
    .excel-container::-webkit-scrollbar { height: 14px; width: 14px; }
    .excel-container::-webkit-scrollbar-track { background: #f1f1f1; }
    .excel-container::-webkit-scrollbar-thumb { background: #888; border-radius: 7px; border: 3px solid #f1f1f1; }
    .excel-container::-webkit-scrollbar-thumb:hover { background: #555; }

    .table-excel { width: max-content; min-width: 100%; border-collapse: collapse; background-color: #fff; table-layout: fixed; }
    
    .table-excel th { 
        background-color: #e6e6e6; color: #000; font-weight: 700; text-align: center; 
        border: 1px solid #999; padding: 8px 4px; font-size: 12px; 
        position: sticky; top: 0; z-index: 20; white-space: nowrap; box-shadow: 0 1px 0 #999; 
    }
    .table-excel td { border: 1px solid #b2b2b2 !important; padding: 0; margin: 0; height: 30px; vertical-align: middle; position: relative; } 
    
    .excel-input { 
        width: 100%; min-height: 28px; height: 100%; border: none; padding: 4px 6px; outline: none; 
        font-size: 12px; background: transparent; display: block; font-family: inherit; 
        line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: clip; 
    }
    .excel-input:focus { outline: 2px solid #107c41; outline-offset: -2px; z-index: 2; position: relative; background: white; }
    
    .input-row { background-color: #f8f9fa; border-bottom: 2px solid #107c41; } 
    .row-num { background-color: #e6e6e6; text-align: center; color: #333; font-weight: bold; width: 40px; border-right: 3px solid #ccc !important; }

    /* --- ESTILOS ULTRA COMPACTOS (MINI DASHBOARD) --- */
    .mini-table { width: auto !important; min-width: 0 !important; }
    .mini-table th { 
        padding: 1px 2px; font-size: 9px; height: 18px; line-height: 1; border-bottom: 2px solid #999; 
    }
    .mini-table td { 
        height: 18px; font-size: 9px; padding: 0 2px; line-height: 18px; 
    }
    .mini-table .total-row td { background-color: #333; color: white; font-weight: bold; border-color: #555 !important; }

    /* --- ESTILOS PPC DINÁMICO (WHITE MODE / CLEAN) --- */
    .dynamic-tracker { 
        background-color: #f4f6f8 !important; 
        color: #333; 
        flex:1; display:flex; flex-direction:column; padding:0 !important; overflow-y:auto; 
    }
    .dynamic-form-card { 
        background: #ffffff; 
        border: 1px solid #dfe3e8; 
        border-radius: 8px; 
        padding: 25px; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        /* CENTRADO DE LA TARJETA */
        max-width: 960px; 
        width: 100%;
        margin: 0 auto;
    }
    .dynamic-input { 
        background: #ffffff; 
        border: 1px solid #ced4da; 
        color: #333; 
        padding: 8px 12px; 
        border-radius: 4px; 
        width: 100%; 
        font-size: 13px; 
        transition: border-color 0.2s;
    }
    .dynamic-input:focus { 
        outline: none; 
        border-color: #e83e8c; 
        box-shadow: 0 0 0 2px rgba(232, 62, 140, 0.1); 
    }
    .dynamic-label { 
        font-size: 11px; 
        font-weight: 700; 
        color: #637381; 
        margin-bottom: 6px; 
        display: block; 
        text-transform: uppercase; 
        letter-spacing: 0.5px; 
    }
    
    /* Chips para Dinamico (Tema Claro) */
    .chip-option { 
        cursor: pointer; 
        padding: 6px 14px; 
        border-radius: 15px; 
        background: #f1f3f5; 
        border: 1px solid #dee2e6; 
        color: #495057; 
        font-size: 11px; 
        margin-right: 6px; 
        display: inline-block; 
        transition: all 0.2s; 
        font-weight: 500;
    }
    .chip-option:hover { background: #e9ecef; border-color: #ced4da; }
    .chip-option.selected { 
        background: #e83e8c; 
        color: white; 
        border-color: #e83e8c; 
        box-shadow: 0 2px 5px rgba(232, 62, 140, 0.3); 
    }

    /* LAYOUT GENERAL */
    .app-wrapper { display: flex; height: 100vh; width: 100vw; }
    .sidebar { width: var(--sidebar-w); background: var(--primary); color: #a2a3b7; display: flex; flex-direction: column; }
    .menu { flex: 1; overflow-y: auto; padding: 20px 0; }
    .menu::-webkit-scrollbar { width: 8px; }
    .menu::-webkit-scrollbar-track { background: #1b1b29; } 
    .menu::-webkit-scrollbar-thumb { background: #3f4050; border-radius: 4px; }
    .nav-item { padding: 12px 25px; cursor: pointer; display: flex; align-items: center; color: #a2a3b7; transition: 0.2s; }
    .nav-item:hover { color: white; background: rgba(255,255,255,0.03); }
    .nav-item.active { background: #1b1b29; color: var(--accent); } 
    .top-bar { height: 70px; background: white; border-bottom: 1px solid #eff2f5; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
    
    /* COMPONENTES */
    .login-overlay { position: fixed; inset: 0; background: var(--primary); z-index: 2000; display: flex; align-items: center; justify-content: center; }
    .login-card { background: #1c1c1c; padding: 40px; border-radius: 15px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.5); color: #eee; position: relative; overflow: hidden; }
    .login-logo { max-width: 85%; height: auto; margin-bottom: 25px; -webkit-mask-image: radial-gradient(ellipse at center, black 40%, transparent 100%); mask-image: radial-gradient(ellipse at center, black 40%, transparent 100%); }
    .login-card .form-control { background: #2a2a3b; border: 1px solid #444; color: white; }
    .login-card .form-control::placeholder { color: #888; }
    .login-card .form-control:focus { background: #333; border-color: var(--accent); box-shadow: none; }
    .login-card h3 { color: white !important; }
    .login-card p.text-muted { color: #aaa !important; }

    .dept-card, .staff-card { background: white; border-radius: 12px; box-shadow: 0 0 20px 0 rgba(0,0,0,0.03); padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; }
    .dept-card:hover, .staff-card:hover { transform: translateY(-5px); border-color: var(--accent); }
    .chip-container { border: 1px solid #ccc; background: white; padding: 2px; display: flex; flex-wrap: wrap; gap: 2px; min-height: 100%; align-items: center; }
    .user-chip { background: #e8f0fe; border: 1px solid #d2e3fc; border-radius: 4px; padding: 0 4px; font-size: 11px; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
    .file-input-hidden { display: none; } 
    .btn-attach { border: 1px solid #ccc; background: #f8f9fa; color: #666; padding: 4px 10px; font-size: 12px; border-radius: 4px; cursor: pointer; }
    .btn-attach.has-file { background: #d4edda; color: #155724; border-color: #c3e6cb; }
    .iframe-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: white; display: flex; flex-direction: column; }
    .iframe-toolbar { height: 45px; background: #333; color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; }
    iframe { flex: 1; width: 100%; border: none; }
    
    /* MODAL */
    .custom-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1050; display: flex; align-items: center; justify-content: center; }
    .custom-modal { background: white; width: 400px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); overflow: hidden; }
    .custom-modal-header { background: #f8f9fa; padding: 15px; border-bottom: 1px solid #dee2e6; font-weight: bold; display: flex; justify-content: space-between; }
    .custom-modal-body { padding: 20px; }
    .custom-modal-footer { padding: 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; text-align: right; }
    .chip-select { cursor: pointer; padding: 6px 12px; border-radius: 20px; background: #f1f3f5; color: #495057; font-size: 11px; margin-right: 5px; margin-bottom: 5px; display: inline-block; border: 1px solid #dee2e6; transition: 0.2s; font-weight: 500; }
    .chip-select.active { background: #3699ff; color: white; border-color: #3699ff; box-shadow: 0 2px 5px rgba(54, 153, 255, 0.3); }
  </style>
</head>
<body>

<div id="app">
  <div v-if="!isLoggedIn" class="login-overlay">
    <div class="login-card">
      <img src="https://drive.google.com/thumbnail?id=1tmNuwauWNjOhv0JwX6ug9pzvsrBCNX7z&sz=w1000" class="login-logo" alt="Logo">
      <h3 class="fw-bold mb-4">BIENVENIDO</h3>
      <p class="text-muted mb-4">Acceso Seguro</p>
      <div class="mb-3">
          <input type="text" v-model="loginUser" class="form-control text-center mb-2" placeholder="Usuario">
          <input type="password" v-model="loginPass" class="form-control text-center" placeholder="Contraseña..." @keyup.enter="doLogin">
      </div>
      <button class="btn btn-success w-100 fw-bold" @click="doLogin" :disabled="loggingIn">
        <span v-if="loggingIn">Conectando...</span><span v-else>INICIAR SESIÓN</span>
      </button>
    </div>
  </div>

  <div v-if="isLoggedIn" class="app-wrapper">
    <aside class="sidebar">
      <div class="brand p-3 fw-bold text-white"><i class="fas fa-table me-2 text-primary"></i> HOLTMONT</div>
      <div class="menu">
        <div class="nav-item" :class="{ active: currentView === 'DASHBOARD' }" @click="goHome"><i class="fas fa-th me-2"></i> Dashboard</div>
        
        <div v-if="config.specialModules.length">
            <div style="padding:15px 20px 5px;font-size:0.7rem;color:#888;font-weight:bold">ACCIONES</div>
            <div class="nav-item" v-for="m in config.specialModules" @click="openModule(m)" :class="{ active: currentModuleId === m.id }" :style="{ borderRight: currentModuleId === m.id ? '3px solid ' + m.color : '3px solid transparent' }">
                <i class="fas me-2" :class="m.icon" :style="{color: m.color}"></i>
                <span :style="{ color: currentModuleId === m.id ? 'white' : '#a2a3b7' }">{{m.label}}</span>
            </div>
        </div>

        <div v-if="Object.keys(config.departments).length">
            <div style="padding:15px 20px 5px;font-size:0.7rem;color:#888;font-weight:bold">ÁREAS</div>
            <div class="nav-item" v-for="(d,k) in config.departments" @click="selectDept(k)" :class="{ active: currentDept === k }" :style="{ borderRight: currentDept === k ? '3px solid ' + d.color : '3px solid transparent' }">
                <i class="fas me-2" :class="d.icon" :style="{ color: d.color }"></i>
                <span :style="{ color: currentDept === k ? 'white' : '#a2a3b7' }">{{d.label}}</span>
            </div>
        </div>

        <div class="mt-auto">
            <div class="p-3">
                <button class="btn btn-outline-secondary w-100 btn-sm" @click="logout">Salir</button>
            </div>
            <div class="text-center pb-4 mb-2">
                <img src="https://lh3.googleusercontent.com/d/1tmNuwauWNjOhv0JwX6ug9pzvsrBCNX7z" alt="Logo Footer" style="max-width: 100px; height:auto; opacity: 0.5; filter: grayscale(100%) invert(1);">
            </div>
        </div>
      </div>
    </aside>

    <main class="content-wrapper">
      <div class="top-bar">
        <h6 class="m-0 fw-bold text-secondary">{{ pageTitle }}</h6>
        <span class="badge bg-light text-dark border">{{ currentUser }}</span>
      </div>

      <div class="view-area" v-if="!['IFRAME', 'MODULE_TABS'].includes(currentView)">
        <div v-if="currentView === 'DASHBOARD'" class="row g-3">
          <div class="col-md-4 col-lg-3" v-for="mod in config.specialModules" :key="mod.id">
            <div class="dept-card" @click="openModule(mod)" :style="{borderTop: '4px solid '+mod.color}">
                <i class="fas fa-2x mb-3" :class="mod.icon" :style="{color: mod.color}"></i>
                <h6 class="fw-bold" :style="{color: mod.color}">{{mod.label}}</h6>
            </div>
          </div>
          <div class="col-md-4 col-lg-3" v-for="(dept, key) in config.departments" :key="key">
            <div class="dept-card" @click="selectDept(key)" :style="{borderTop: '4px solid '+dept.color}">
                <i class="fas fa-2x mb-3" :class="dept.icon" :style="{color: dept.color}"></i>
                <h6 class="fw-bold" :style="{color: dept.color}">{{dept.label}}</h6>
            </div>
          </div>
        </div>

        <div v-if="currentView === 'DEPT'">
          <div class="d-flex justify-content-between mb-3"><button class="btn btn-light btn-sm border" @click="goHome">Atrás</button><input v-model="searchQuery" class="form-control form-control-sm w-auto" placeholder="Filtrar..."></div>
          <div class="row g-2">
            <div class="col-md-3" v-for="p in filteredStaff" :key="p.name">
              <div class="staff-card h-100" @click="openStaffTracker(p)" :style="{borderTop: '4px solid ' + (currentDeptData.color || '#3699ff')}">
                <div class="mb-2 fw-bold" :style="{color: currentDeptData.color || '#555'}" style="font-size:1.2rem">{{p.name.charAt(0)}}</div>
                <div class="small fw-bold">{{p.name}}</div>
              </div>
            </div>
          </div>
        </div>

        <div v-if="currentView === 'STAFF_TRACKER'" class="h-100 d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white border rounded">
            <div class="d-flex align-items-center">
                <button class="btn btn-light btn-sm border me-2" @click="goBackToDept"><i class="fas fa-arrow-left"></i></button>
                <span class="small fw-bold me-2" :style="{color: currentDeptData.color || 'var(--primary)'}"><i class="fas fa-file-excel me-1"></i> {{ staffTracker.name }}</span>
                <button class="btn btn-primary btn-sm py-0 px-2 me-1" @click="reloadStaffTracker" title="Actualizar"><i class="fas fa-sync-alt me-1"></i> Actualizar</button>
                <button class="btn btn-success btn-sm py-0 px-2" @click="addNewRow" title="Agregar"><i class="fas fa-plus me-1"></i> Fila</button>
            </div>
            <div></div>
          </div>
          
          <div class="excel-container flex-fill mb-2">
             <div v-if="staffTracker.isLoading" class="text-center p-5 text-muted">Cargando datos...</div>
             <table v-else class="table-excel">
                <thead>
                  <tr>
                    <th class="row-num">#</th>
                    <th style="width:40px"><i class="fas fa-save"></i></th>
                    <th v-for="(h, idx) in staffTracker.headers" :key="idx" :style="getColumnStyle(h)">
                        {{ getHeaderLabel(h) }}
                    </th>
                  </tr>
                </thead>
                <tbody>
                   <tr v-for="(row, i) in staffTracker.data" :key="i" :class="{'new-row-highlight': row._isNew}">
                      <td class="row-num">{{i+1}}</td>
                      <td class="text-center" style="background:#f8f9fa"><button class="btn btn-link btn-sm p-0 text-success" @click="saveRow(row)"><i class="fas fa-save"></i></button></td>
                      
                      <td v-for="(h, idx) in staffTracker.headers" :key="idx">
                         <div v-if="isCol(h, ['AREA','ALTA'])" style="position:relative; width:100%; height:100%;">
                             <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; font-weight:bold; font-size:12px;">{{ row[h] ? String(row[h]).charAt(0).toUpperCase() : '' }}</div>
                             <select v-model="row[h]" style="position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer;"><option value="">-</option><option v-for="(dept, k) in (config.allDepartments || config.departments)" :key="k" :value="k">{{dept.label}}</option></select>
                         </div>
                         <div v-else-if="isCol(h, ['VENDEDOR'])" style="position:relative; width:100%; height:100%; background-color:#f0fdf4;">
                             <div style="position:absolute; inset:0; display:flex; align-items:center; padding-left:6px; pointer-events:none; font-size:11px; white-space:nowrap; overflow:hidden;">{{ row[h] ? String(row[h]).split(' ')[0] : '' }}</div>
                             <select v-model="row[h]" style="position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer;"><option value="">-</option><option v-for="s in salesStaff" :key="s" :value="s">{{s}}</option></select>
                         </div>
                         <div v-else-if="isMediaColumn(h)" class="text-center" style="padding-top:4px;">
                             <div v-if="row[h] && String(row[h]).startsWith('http')" class="d-flex justify-content-center align-items-center gap-1">
                                 <a :href="row[h]" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-1"><i class="fas fa-external-link-alt" style="font-size:10px"></i></a>
                                 <button class="btn btn-sm btn-light border py-0 px-1 text-muted" @click="openCellUpload(row, h)"><i class="fas fa-sync" style="font-size:9px"></i></button>
                             </div>
                             <div v-else><button class="btn btn-sm btn-light border py-0 px-2 text-secondary" @click="openCellUpload(row, h)"><i class="fas fa-cloud-upload-alt"></i></button></div>
                         </div>
                         <div v-else-if="isCol(h, ['CLASIFICACION'])" style="position:relative; width:100%; height:100%;">
                             <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; font-size:10px; font-weight:bold;">{{ row[h] }}</div>
                             <select v-model="row[h]" style="position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer;"><option value="">-</option><option value="A">A</option><option value="AA">AA</option><option value="AAA">AAA</option></select>
                         </div>
                         <input v-else-if="isCol(h, ['DIAS','RELOJ'])" v-model="row[h]" style="text-align:center; font-weight:bold; width:100%; height:100%; border:none; outline:none; padding:6px 0px; background:transparent;" :style="getTrafficStyle(row)">
                         <input v-else-if="String(h).toUpperCase().includes('AVANCE')" v-model="row[h]" style="text-align:center; font-weight:bold; color:#217346; width:100%; height:100%; border:none; outline:none; padding:6px 0px; background:transparent;">
                         <input v-else-if="isCol(h, ['ESTATUS','STATUS'])" v-model="row[h]" style="text-align:center; font-weight:bold; font-size:10px; width:100%; height:100%; border:none; outline:none; padding:6px 1px; background:transparent;" class="excel-input">
                         
                         <div v-else-if="String(h).toUpperCase().includes('FECHA')" 
                              style="position:relative; width:100%; height:100%;"
                              :style="isCol(h, ['FECHA RESPUESTA', 'FECHA DE RESPUESTA', 'FEC. EST. FIN', 'FECHA ESTIMADA DE FIN']) ? getFechaRespuestaStyle(row) : {}">
                             <div style="position:absolute; inset:0; display:flex; align-items:center; padding-left:4px; font-size:12px; pointer-events:none;">{{ formatDisplayDate(row[h]) }}</div>
                             <input type="date" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;" :value="toIsoDate(row[h])" @input="updateDateFromPicker($event, row, h)">
                         </div>
                         
                         <input v-else v-model="row[h]" class="excel-input" spellcheck="false">
                      </td>
                   </tr>
                </tbody>
             </table>
          </div>
          <div class="excel-container flex-fill" v-if="staffTracker.history.length" style="max-height:30%">
             <div class="sticky-top bg-light border-bottom px-2 small fw-bold text-muted">HISTORIAL</div>
             <table class="table-excel"><tbody><tr v-for="(row, i) in staffTracker.history" :key="i"><td class="row-num">H{{i+1}}</td><td style="width:40px;text-align:center"><i class="fas fa-check text-muted small"></i></td><td v-for="(h, idx) in staffTracker.headers" :key="idx" :style="getColumnStyle(h)">{{row[h]}}</td></tr></tbody></table>
          </div>
        </div>

        <div v-if="currentView === 'PPC_DINAMICO'" class="h-100 dynamic-tracker" style="padding:20px !important;">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold m-0" style="color:#2c3e50"><i class="fas fa-layer-group me-2" style="color:#e83e8c"></i>Tracker</h4>
            <button class="btn btn-outline-secondary btn-sm" @click="goHome">Cerrar</button>
          </div>

          <div class="dynamic-form-card">
             <div class="row g-3">
                 <div class="col-md-6">
                     <label class="dynamic-label">Especialidad (Departamento)</label>
                     <select v-model="dynamicPpc.especialidad" class="dynamic-input">
                         <option value="" disabled>Seleccionar...</option>
                         <option v-for="(d,k) in (config.allDepartments || config.departments)" :key="k" :value="k">{{d.label}}</option>
                     </select>
                 </div>
                 <div class="col-md-6">
                     <label class="dynamic-label">Clasificación</label>
                     <select v-model="dynamicPpc.clasificacion" class="dynamic-input">
                         <option value="A">A</option>
                         <option value="AA">AA</option>
                         <option value="AAA">AAA</option>
                     </select>
                 </div>

                 <div class="col-12">
                     <label class="dynamic-label">Responsable</label>
                     <div class="dynamic-input" style="min-height:38px; display:flex; flex-wrap:wrap; gap:5px; align-items:center;" @click="$refs.chipDyn.focus()">
                         <span v-for="(u,i) in selectedResponsables" :key="i" class="user-chip">
                             {{u}} <i class="fas fa-times ms-2 text-secondary" style="cursor:pointer" @click.stop="selectedResponsables.splice(i,1)"></i>
                         </span>
                         <input ref="chipDyn" v-model="staffSearch" style="background:transparent; border:none; color:#333; outline:none; min-width:60px;" placeholder="+">
                     </div>
                     <ul class="list-group position-absolute shadow" style="z-index:100; max-height:150px; overflow:auto; width:300px; margin-top:5px;" v-if="staffSearch">
                         <li v-for="p in filteredDirectory" :key="p.name" class="list-group-item list-group-item-action small py-1" style="cursor:pointer;" @click="addResponsable(p.name)">{{p.name}}</li>
                     </ul>
                 </div>

                 <div class="col-12">
                     <label class="dynamic-label">Descripción de la Actividad</label>
                     <textarea v-model="dynamicPpc.concepto" class="dynamic-input" rows="3"></textarea>
                 </div>

                 <div class="col-md-6">
                     <label class="dynamic-label">Riesgos</label>
                     <div>
                         <span v-for="r in ['BAJO','MEDIO','ALTO','CATASTROFICO']" :key="r" class="chip-option" :class="{selected: dynamicPpc.riesgos === r}" @click="dynamicPpc.riesgos = r">{{r}}</span>
                     </div>
                 </div>
                 <div class="col-md-6">
                     <label class="dynamic-label">Prioridad</label>
                     <div>
                         <span v-for="p in ['BAJA','MEDIA','URGENTE']" :key="p" class="chip-option" :class="{selected: dynamicPpc.prioridad === p}" @click="dynamicPpc.prioridad = p">{{p}}</span>
                     </div>
                 </div>

                 <div class="col-md-3">
                     <label class="dynamic-label">Fecha de Finalización</label>
                     <input type="date" v-model="dynamicPpc.fechaFin" class="dynamic-input">
                 </div>
                 <div class="col-md-3">
                     <label class="dynamic-label">Archivos</label>
                     <button class="btn btn-outline-primary w-100 btn-sm" @click="openFileDialog" style="border-style:dashed; height:36px;">
                         <i class="fas" :class="uploadSuccess ? 'fa-check text-success' : 'fa-cloud-upload-alt'"></i> {{ uploadSuccess ? 'Archivo Listo' : 'SUBIR ARCHIVO' }}
                     </button>
                     <input type="file" ref="fileInput" class="file-input-hidden" @change="handleFileSelect">
                 </div>
                 <div class="col-md-6">
                     <label class="dynamic-label">Comentarios</label>
                     <input v-model="dynamicPpc.comentarios" class="dynamic-input">
                 </div>
             </div>

             <div class="mt-4 text-end">
                 <button class="btn btn-lg fw-bold px-5 text-white" style="background:#e83e8c; border:none; box-shadow: 0 4px 6px rgba(232, 62, 140, 0.3);" @click="saveDynamicPPC" :disabled="isSubmitting">
                     <i class="fas fa-save me-2"></i> GUARDAR REGISTRO
                 </button>
             </div>
          </div>
        </div>

        <div v-if="currentView === 'PPC_FORM'" class="h-100 d-flex flex-column" style="background:white; padding:20px;">
           <div class="d-flex justify-content-between align-items-center mb-3">
               <h5 class="m-0 text-primary"><i class="fas fa-th me-2"></i>PPC Maestro</h5>
               <button class="btn btn-light border" @click="goHome">Cerrar</button>
           </div>

           <div class="d-flex mb-3 align-items-end justify-content-center position-relative" style="min-height: 90px;">
               <div style="position: absolute; left: 0; bottom: 0; height: 90px; border: none; background: transparent; overflow: hidden; z-index: 0;">
                    <img src="https://drive.google.com/thumbnail?id=1hJ8lTZ9nHRueCjwHMGrb5mm5EQucJ0ia&sz=w1000" style="width: auto; height: 100%; object-fit: contain; object-position: left bottom;" alt="Logo PPC">
               </div>

               <div class="excel-container" style="max-height: 150px; flex:none; width: fit-content; z-index: 1;">
                   <table class="table-excel mini-table"> 
                       <thead>
                           <tr>
                               <th style="width:90px">ESPECIALIDAD</th>
                               <th style="width:35px">ACT</th>
                               <th style="width:35px">CUMP</th>
                               <th style="width:35px">PROM</th>
                               <th style="width:35px">ANT</th>
                           </tr>
                       </thead>
                       <tbody>
                           <tr v-for="stat in deptStats" :key="stat.key" :class="{'total-row': stat.key === 'TOTAL'}">
                               <td style="font-weight:bold; padding-left:5px;">{{ stat.label }}</td>
                               <td class="text-center">{{ stat.actual }}</td>
                               <td class="text-center text-success fw-bold">{{ stat.cumplidas }}</td>
                               <td class="text-center">{{ stat.promedio }}</td>
                               <td class="text-center text-muted">{{ stat.anterior }}</td>
                           </tr>
                       </tbody>
                   </table>
               </div>
           </div>
           <div class="excel-container flex-fill mb-3">
               <table class="table-excel">
                   <thead>
                       <tr>
                           <th class="row-num">#</th>
                           <th style="width:100px">Depto</th>
                           <th style="min-width:400px">Descripción Actividad</th>
                           <th style="width:150px">Responsable</th>
                           <th style="width:80px">Fecha Alta</th>
                           <th style="width:40px">Reloj</th>
                           <th style="width:50px">Cumpl.</th>
                           <th style="width:40px">Clip</th>
                           <th style="min-width:150px">Comentarios Sem. Curso</th>
                           <th style="min-width:150px">Comentarios Sem. Previa</th>
                           <th style="width:50px"></th>
                       </tr>
                   </thead>
                   <tbody>
                       <tr class="input-row">
                           <td class="row-num">></td>
                           <td><select v-model="ppcData.especialidad" class="excel-input" style="background:#f0fdf4"><option value="" disabled>Sel...</option><option v-for="(d,k) in (config.allDepartments || config.departments)" :key="k" :value="k">{{d.label}}</option></select></td>
                           <td><input v-model="ppcData.concepto" class="excel-input" placeholder="Descripción..." style="background:#f0fdf4"></td>
                           <td style="background:#f0fdf4; position:relative;"><div class="chip-container" @click="$refs.chipIn.focus()"><span v-for="(u,i) in selectedResponsables" :key="i" class="user-chip">{{u}}<i class="fas fa-times ms-1 text-danger" style="cursor:pointer" @click.stop="selectedResponsables.splice(i,1)"></i></span><input ref="chipIn" v-model="staffSearch" style="border:none;outline:none;min-width:40px;font-size:12px;background:transparent;" placeholder="+"></div><ul class="list-group position-absolute w-100 shadow" style="z-index:100;max-height:150px;overflow:auto;top:100%;left:0" v-if="staffSearch"><li v-for="p in filteredDirectory" :key="p.name" class="list-group-item list-group-item-action small py-1" @click="addResponsable(p.name)">{{p.name}}</li></ul></td>
                           <td class="text-center small text-muted">HOY</td>
                           <td><input v-model="ppcData.horas" class="excel-input" style="background:#f0fdf4; text-align:center;"></td>
                           <td><select v-model="ppcData.cumplimiento" class="excel-input" style="background:#f0fdf4"><option value="NO">NO</option><option value="SI">SI</option></select></td>
                           <td class="text-center" style="background:#f0fdf4"><button class="btn-attach" :class="{'has-file': uploadSuccess}" @click="openFileDialog"><i class="fas" :class="uploadSuccess ? 'fa-check' : 'fa-paperclip'"></i></button><input type="file" ref="fileInput" class="file-input-hidden" @change="handleFileSelect"></td>
                           <td><input v-model="ppcData.comentarios" class="excel-input" placeholder="..." style="background:#f0fdf4"></td>
                           <td><input v-model="ppcData.comentariosPrevios" class="excel-input" placeholder="..." style="background:#f0fdf4"></td>
                           <td class="text-center"><button class="btn btn-primary btn-sm py-0" @click="promptExtraData" title="Más Detalles">+</button></td>
                       </tr>

                       <tr v-for="(item, idx) in activityQueue" :key="idx">
                           <td class="row-num">{{ idx + 1 }}</td>
                           <td><input :value="item.especialidad" readonly class="excel-input"></td>
                           <td><input :value="item.concepto" readonly class="excel-input"></td>
                           <td><div style="padding:0 8px; overflow:hidden; white-space:nowrap; font-size:12px">{{ item.responsable }}</div></td>
                           <td class="text-center small">{{ new Date().toLocaleDateString() }}</td>
                           <td><input :value="item.horas" readonly class="excel-input" style="text-align:center;"></td>
                           <td><input :value="item.cumplimiento" readonly class="excel-input"></td>
                           <td class="text-center"><i class="fas fa-file-pdf text-danger" v-if="item.archivoUrl"></i></td>
                           <td><input :value="item.comentarios" readonly class="excel-input"></td>
                           <td><input :value="item.comentariosPrevios" readonly class="excel-input"></td>
                           <td class="text-center"><i class="fas fa-trash text-danger" style="cursor:pointer" @click="activityQueue.splice(idx,1)"></i></td>
                       </tr>
                   </tbody>
               </table>
           </div>
           <div class="d-flex justify-content-end"><button class="btn btn-success fw-bold" @click="submitBatch" :disabled="isSubmitting || !activityQueue.length">{{ isSubmitting ? 'Procesando...' : 'GUARDAR TODO' }}</button></div>
        </div>
      </div>
      
      <div v-if="['IFRAME', 'MODULE_TABS'].includes(currentView)" class="iframe-container"><div class="iframe-toolbar"><span class="fw-bold">{{ iframeTitle }}</span><button class="btn btn-sm btn-danger" @click="closeIframe">Cerrar</button></div><iframe :src="currentIframeUrl"></iframe></div>
    </main>
  </div>

  <input type="file" ref="cellFileInput" class="file-input-hidden" @change="handleCellFile">

  <div v-if="showExtraModal" class="custom-modal-overlay">
      <div class="custom-modal">
          <div class="custom-modal-header"><span>Detalles Adicionales</span><button type="button" class="btn-close" @click="showExtraModal = false"></button></div>
          <div class="custom-modal-body">
              <div class="mb-2"><label class="small fw-bold mb-1">Prioridades:</label><div><span v-for="opt in priorityOpts" :key="opt" class="chip-select" :class="{active: extraData.prioridades === opt}" @click="extraData.prioridades = opt">{{ opt }}</span></div></div>
              <div class="mb-2"><label class="small fw-bold mb-1">Riesgos:</label><div><span v-for="opt in riskOpts" :key="opt" class="chip-select" :class="{active: extraData.riesgos === opt}" @click="extraData.riesgos = opt">{{ opt }}</span></div></div>
              <div class="mb-2"><label class="small fw-bold">Restricciones:</label><input v-model="extraData.restricciones" class="form-control form-control-sm" placeholder="Escribir..."></div>
              <div class="mb-2"><label class="small fw-bold">Fecha Respuesta:</label><input type="date" v-model="extraData.fechaRespuesta" class="form-control form-control-sm"></div>
          </div>
          <div class="custom-modal-footer"><button class="btn btn-primary btn-sm w-100" @click="confirmAddToQueue">Guardar y Agregar</button></div>
      </div>
  </div>
</div>

<script>
  window.onerror = function(msg, url, line) { if(String(msg).toLowerCase().includes("script error")) return; Swal.fire({ icon: 'error', title: 'Error de Renderizado', text: 'Ocurrió un error visual: ' + err.message }); };

  const { createApp, ref, computed } = Vue;
  const app = createApp({
    setup() {
      // ESTADO
      const isLoggedIn = ref(false); const loginPass = ref(''); const loginUser = ref(''); const loggingIn = ref(false); const currentUser = ref('');
      const currentView = ref('DASHBOARD'); const currentDept = ref('');
      const config = ref({ departments: {}, staff: [], directory: [], specialModules: [] });
      const staffTracker = ref({ name: '', data: [], history: [], headers: [], isLoading: false, previousView: 'DEPT' });
      const searchQuery = ref(''); 
      
      // ESTADO PPC
      const ppcData = ref({ cumplimiento: 'NO', cliente: '', comentarios:'', comentariosPrevios:'' }); 
      const isSubmitting = ref(false);
      const selectedResponsables = ref([]); const staffSearch = ref(''); const activityQueue = ref([]); 
      const ppcExistingData = ref([]); 
      
      const isUploadingFile = ref(false); const uploadSuccess = ref(false); const fileInput = ref(null);
      const currentIframeUrl = ref(''); const iframeTitle = ref(''); 
      
      const showExtraModal = ref(false);
      const extraData = ref({ restricciones: '', prioridades: '', riesgos: '', fechaRespuesta: '' });
      const priorityOpts = ['URGENTE', 'MEDIA', 'BAJA'];
      const riskOpts = ['ALTO', 'BAJO', 'CATASTROFICO'];
      const cellFileInput = ref(null);
      const uploadingCell = ref({row:null, col:null});

      // --- NUEVO ESTADO PARA PPC DINÁMICO ---
      const dynamicPpc = ref({ especialidad: '', clasificacion: 'A', concepto: '', riesgos: 'BAJO', prioridad: 'MEDIA', fechaFin: '', comentarios: '', archivoUrl: '' });

      // COMPUTADAS
      const salesStaff = computed(() => (config.value.directory || []).filter(p => p.dept === 'VENTAS' && p.name !== 'ANTONIA_VENTAS').map(p => p.name));
      const filteredStaff = computed(() => config.value.staff.filter(p => p.dept === currentDept.value && p.name.toLowerCase().includes(searchQuery.value.toLowerCase())));
      const filteredDirectory = computed(() => (config.value.directory || config.value.staff).filter(p => p.name.toLowerCase().includes(staffSearch.value.toLowerCase()) && !selectedResponsables.value.includes(p.name)).slice(0,5));
      const pageTitle = computed(() => currentView.value);
      const currentDeptData = computed(() => config.value.departments[currentDept.value] || {});
      const currentModuleId = ref(''); // Nueva ref para el menu

      // --- LOGICA DE ESTADISTICAS PPC CON TOTALES (CORREGIDA) ---
      const deptStats = computed(() => {
          const stats = [];
          let totalActual = 0;
          let totalCumplidas = 0;
          let totalGlobalDB = 0;
          
          // ITERAMOS SOBRE allDepartments SI EXISTE, SINO departments
          const deptsToIterate = config.value.allDepartments || config.value.departments;

          for (const key in deptsToIterate) {
              const deptLabel = deptsToIterate[key].label;
              const actual = activityQueue.value.filter(i => i.especialidad === key).length;
              const totalDB = ppcExistingData.value.filter(i => i.especialidad === key || i.especialidad === deptLabel);
              const cumplidas = totalDB.filter(i => String(i.cumplimiento).toUpperCase() === 'SI').length;
              let prom = 0;
              if (totalDB.length > 0) prom = Math.round((cumplidas / totalDB.length) * 100);
              
              // ACUMULAR
              totalActual += actual;
              totalCumplidas += cumplidas;
              totalGlobalDB += totalDB.length;

              stats.push({
                  key: key,
                  label: deptLabel.toUpperCase(),
                  actual: actual,
                  cumplidas: cumplidas,
                  promedio: prom + '%',
                  anterior: '0%' 
              });
          }
          
          // FILA TOTAL
          let totalProm = 0;
          if (totalGlobalDB > 0) totalProm = Math.round((totalCumplidas / totalGlobalDB) * 100);
          
          stats.push({
              key: 'TOTAL',
              label: 'TOTAL',
              actual: totalActual,
              cumplidas: totalCumplidas,
              promedio: totalProm + '%',
              anterior: '0%'
          });

          return stats;
      });

      // FUNCIONES DE ESTILO
      const isCol = (h, list) => list.includes(String(h).toUpperCase().trim());
      const getColumnStyle = (h) => {
          const up = String(h).toUpperCase();
          let w = '120px'; let fs = '12px'; let pad = '8px 4px';
          
          if (up === 'CONCEPTO') w = '1200px';
          
          // --- NUEVAS REGLAS DE REDUCCION DE ESPACIO ---
          else if (up === 'HORA') { w = '50px'; fs = '10px'; }
          else if (up === 'FECHA ESTIMADA DE FIN') { w = '75px'; fs = '10px'; }
          else if (up === 'HORA ESTIMADA DE FIN') { w = '60px'; fs = '10px'; }
          else if (up.includes('PRIORIDAD')) { w = '70px'; fs = '10px'; } // Prioridades
          else if (up.includes('RIESGO')) { w = '70px'; fs = '10px'; } // Riesgos
          // ---------------------------------------------
          
          else if (isCol(h, ['FOLIO','AREA','ALTA'])) w = '50px';
          else if (isCol(h, ['DIAS','RELOJ','CLASIFICACION'])) { w = '40px'; fs = '10px'; pad = '8px 1px'; }
          else if (up.includes('AVANCE')) { w = '40px'; fs = '10px'; pad = '8px 1px'; }
          else if (isCol(h, ['ESTATUS','STATUS'])) { w = '65px'; fs = '10px'; pad = '8px 1px'; }
          else if (up.includes('FECHA') || up.includes('RESPUESTA')) { w = '65px'; fs = '10px'; }
          else if (up === 'VENDEDOR') { w = '75px'; fs = '10px'; }
          else if (up === 'CLIENTE') w = '200px';
          return { width: w, fontSize: fs, padding: pad, overflow: 'hidden', textOverflow: 'ellipsis' };
      };
      
      const getHeaderLabel = (h) => {
          const up = String(h).toUpperCase().trim();
          if (up === 'CLASIFICACION') return 'CLASI';
          if (up === 'FECHA ESTIMADA DE FIN') return 'FEC. EST. FIN';
          if (up === 'HORA ESTIMADA DE FIN') return 'HR. EST. FIN';
          return h;
      };

      const getTrafficStyle = (row) => {
          const t = String(row['CLASIFICACION']||'').trim().toUpperCase(); 
          const d = parseInt(row['DIAS']||row['RELOJ']||0);
          if (isNaN(d)) return {};
          if(t==='A') return d>=3?{backgroundColor:'#e74c3c',color:'white'}:(d===2?{backgroundColor:'#f1c40f',color:'black'}:{backgroundColor:'#2ecc71',color:'white'});
          if(t==='AA') return d>=7?{backgroundColor:'#e74c3c',color:'white'}:(d>=4?{backgroundColor:'#f1c40f',color:'black'}:{backgroundColor:'#2ecc71',color:'white'});
          if(t==='AAA') return d>=30?{backgroundColor:'#e74c3c',color:'white'}:(d>=11?{backgroundColor:'#f1c40f',color:'black'}:{backgroundColor:'#2ecc71',color:'white'});
          return {};
      };

      // --- LOGICA DE SEMÁFORO PARA FECHA RESPUESTA ---
      const getFechaRespuestaStyle = (row) => {
          const startKey = Object.keys(row).find(k => ['FECHA','FECHA INICIO','FECHA DE INICIO'].includes(String(k).toUpperCase().trim()));
          const startDateVal = startKey ? row[startKey] : null;
          const style = { backgroundColor: '#ffc107', color: 'black' }; // Amarillo
          if (!startDateVal) return style;

          let startDate = null;
          if (typeof startDateVal === 'string') {
              const parts = startDateVal.split('/');
              if (parts.length === 3) {
                   let y = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                   startDate = new Date(`${y}-${parts[1]}-${parts[0]}`);
              }
          } else if (startDateVal instanceof Date) {
              startDate = startDateVal;
          }

          if (startDate && !isNaN(startDate.getTime())) {
              const now = new Date();
              const diff = now - startDate;
              const days = Math.floor(diff / (1000 * 60 * 60 * 24));
              if (days > 3) {
                  style.backgroundColor = '#dc3545'; // Rojo
                  style.color = 'white';
              }
          }
          return style;
      };

      // ACCIONES
      const handleErr = (e) => { loggingIn.value=false; isSubmitting.value=false; Swal.fire('Error',e.message,'error'); };
      const doLogin = () => { if(!loginPass.value || !loginUser.value) return; loggingIn.value=true; google.script.run.withSuccessHandler(res => { loggingIn.value=false; if(res.success){ isLoggedIn.value=true; currentUser.value=res.name; loadConfig(res.role); } else Swal.fire('Error',res.message,'error'); }).withFailureHandler(handleErr).apiLogin(loginUser.value, loginPass.value); };
      const loadConfig = (r) => google.script.run.withSuccessHandler(d => config.value=d).getSystemConfig(r);
      const logout = () => { isLoggedIn.value=false; loginPass.value=''; loginUser.value=''; currentView.value='DASHBOARD'; };
      const goHome = () => { currentView.value='DASHBOARD'; currentDept.value=''; currentModuleId.value=''; };
      const selectDept = (k) => { currentDept.value=k; currentView.value='DEPT'; searchQuery.value=''; currentModuleId.value=''; };
      const goBackToDept = () => currentView.value=staffTracker.value.previousView;
      
      const openModule = (m) => { 
          currentModuleId.value = m.id;
          currentDept.value = ''; // Limpiar seleccion de depto
          if(m.type==='mirror_staff') openStaffTracker({name:m.target}); 
          else if(m.type==='ppc_native') {
              currentView.value='PPC_FORM'; 
              google.script.run.withSuccessHandler(res => { if(res.success) ppcExistingData.value = res.data; }).apiFetchPPCData();
          }
          else if(m.type==='ppc_dynamic_view') {
             currentView.value='PPC_DINAMICO'; 
             dynamicPpc.value = { especialidad: '', clasificacion: 'A', concepto: '', riesgos: 'BAJO', prioridad: 'MEDIA', fechaFin: '', comentarios: '', archivoUrl: '' };
             selectedResponsables.value = [];
             uploadSuccess.value = false;
          }
      };
      const closeIframe = () => currentView.value='DASHBOARD';
      
      const openStaffTracker = (p) => {
         staffTracker.value.name=p.name; staffTracker.value.previousView=currentView.value; currentView.value='STAFF_TRACKER'; staffTracker.value.isLoading=true;
         google.script.run.withSuccessHandler(res => { 
             staffTracker.value.isLoading=false; 
             if(res.success){ staffTracker.value.data=res.data; staffTracker.value.history=res.history; staffTracker.value.headers=res.headers; } 
             else Swal.fire('Error',res.message,'error'); 
         }).withFailureHandler(handleErr).apiFetchStaffTrackerData(p.name);
      };
      
      const reloadStaffTracker = () => openStaffTracker({name:staffTracker.value.name});
      const addNewRow = () => { if(!staffTracker.value.headers.length) return; const row={_isNew:true}; staffTracker.value.headers.forEach(h=>row[h]=""); staffTracker.value.data.unshift(row); };
      const saveRow = (row) => { 
          Swal.showLoading(); 
          google.script.run.withSuccessHandler(res => { 
              Swal.close(); 
              if(res.success){ row._isNew=false; if(res.moved){ reloadStaffTracker(); Swal.fire({icon: 'success', title: 'Archivado', timer: 1000, showConfirmButton: false}); } else Swal.fire({icon: 'success', title: 'Guardado', timer: 1000, showConfirmButton: false}); } 
              else Swal.fire('Error', res.message, 'error'); 
          }).withFailureHandler(handleErr).apiUpdateTask(staffTracker.value.name, JSON.parse(JSON.stringify(row))); 
      };

      const openCellUpload = (row, col) => { uploadingCell.value = {row, col}; cellFileInput.value.click(); };
      const handleCellFile = (e) => {
          const file = e.target.files[0]; if(!file || !uploadingCell.value.row) return; Swal.showLoading();
          const r = new FileReader();
          r.onload = (ev) => { google.script.run.withSuccessHandler(res => { if(res.success){ uploadingCell.value.row[uploadingCell.value.col] = res.fileUrl; saveRow(uploadingCell.value.row); } else Swal.fire('Error', res.message, 'error'); e.target.value = null; }).uploadFileToDrive(ev.target.result, file.type, file.name); };
          r.readAsDataURL(file);
      };

      const addResponsable = (n) => { selectedResponsables.value.push(n); staffSearch.value=''; };
      const openFileDialog = () => fileInput.value.click();
      const handleFileSelect = (e) => { 
          const file = e.target.files[0]; if(!file) return; 
          
          if(currentView.value === 'PPC_DINAMICO') {
              isUploadingFile.value=true;
              const r = new FileReader(); 
              r.onload=(ev)=>google.script.run.withSuccessHandler(res=>{
                  isUploadingFile.value=false;
                  if(res.success){ uploadSuccess.value=true; dynamicPpc.value.archivoUrl=res.fileUrl; Swal.fire('Archivo Subido','','success'); }
              }).uploadFileToDrive(ev.target.result,file.type,file.name); 
              r.readAsDataURL(file);
          } else {
              isUploadingFile.value=true; 
              const r = new FileReader(); 
              r.onload=(ev)=>google.script.run.withSuccessHandler(res=>{isUploadingFile.value=false;if(res.success){uploadSuccess.value=true;ppcData.value.archivoUrl=res.fileUrl;}}).uploadFileToDrive(ev.target.result,file.type,file.name); 
              r.readAsDataURL(file); 
          }
      };
      
      const promptExtraData = () => { if(!ppcData.value.concepto || !selectedResponsables.value.length) return Swal.fire('Faltan datos básicos','','warning'); extraData.value = { restricciones: '', prioridades: '', riesgos: '', fechaRespuesta: '' }; showExtraModal.value = true; };
      
      const confirmAddToQueue = () => {
          const item = JSON.parse(JSON.stringify(ppcData.value)); item.responsable = selectedResponsables.value.join(','); item.restricciones = extraData.value.restricciones; item.prioridades = extraData.value.prioridades; item.riesgos = extraData.value.riesgos;
          let fResp = extraData.value.fechaRespuesta; if(fResp) { const parts = fResp.split('-'); if(parts.length === 3) fResp = `${parts[2]}/${parts[1]}/${parts[0].slice(-2)}`; } item.fechaRespuesta = fResp;
          activityQueue.value.push(item); 
          ppcData.value.concepto=''; ppcData.value.horas=''; ppcData.value.comentarios=''; ppcData.value.comentariosPrevios='';
          selectedResponsables.value=[]; uploadSuccess.value=false; showExtraModal.value = false;
      };
      
      const saveDynamicPPC = () => {
          if(!dynamicPpc.value.especialidad || !dynamicPpc.value.concepto || !selectedResponsables.value.length) return Swal.fire('Faltan datos obligatorios','','warning');
          
          isSubmitting.value = true;
          let fResp = dynamicPpc.value.fechaFin; 
          if(fResp) { const parts = fResp.split('-'); if(parts.length === 3) fResp = `${parts[2]}/${parts[1]}/${parts[0].slice(-2)}`; }

          const payload = {
              especialidad: dynamicPpc.value.especialidad,
              concepto: dynamicPpc.value.concepto,
              responsable: selectedResponsables.value.join(','),
              clasificacion: dynamicPpc.value.clasificacion,
              riesgos: dynamicPpc.value.riesgos,
              prioridad: dynamicPpc.value.prioridad,
              fechaRespuesta: fResp, 
              archivoUrl: dynamicPpc.value.archivoUrl,
              comentarios: dynamicPpc.value.comentarios,
              horas: '', cumplimiento: 'NO' 
          };

          google.script.run.withSuccessHandler(res => {
              isSubmitting.value = false;
              if(res.success){
                  Swal.fire('Registro Guardado','Enviado a PPC y Tracker','success');
                  dynamicPpc.value = { especialidad: '', clasificacion: 'A', concepto: '', riesgos: 'BAJO', prioridad: 'MEDIA', fechaFin: '', comentarios: '', archivoUrl: '' };
                  selectedResponsables.value = [];
                  uploadSuccess.value = false;
              } else {
                  Swal.fire('Error', res.message, 'error');
              }
          }).withFailureHandler(handleErr).apiSavePPCData([payload]);
      };

      const submitBatch = () => { isSubmitting.value=true; google.script.run.withSuccessHandler(res => { 
          isSubmitting.value=false; 
          if(res.success){ 
              Swal.fire('Guardado','','success'); 
              activityQueue.value=[]; 
              google.script.run.withSuccessHandler(r => { if(r.success) ppcExistingData.value = r.data; }).apiFetchPPCData();
          } else Swal.fire('Error',res.message,'error'); 
      }).withFailureHandler(handleErr).apiSavePPCData(JSON.parse(JSON.stringify(activityQueue.value))); };
      
      const toIsoDate = (val) => { if (!val) return ''; const parts = String(val).split('/'); if (parts.length === 3) { let y = parts[2]; if (y.length === 2) y = '20' + y; return `${y}-${parts[1]}-${parts[0]}`; } return ''; };
      const formatDisplayDate = (val) => { if(!val) return ''; if(String(val).match(/^\d{1,2}\/\d{1,2}\/\d{2}$/)) return val; if(String(val).match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) return val.replace(/\/(\d{4})$/, (m, y) => "/" + y.slice(-2)); return val; };
      const updateDateFromPicker = (e, row, h) => { const val = e.target.value; if (!val) { row[h] = ''; return; } const parts = val.split('-'); if (parts.length === 3) row[h] = `${parts[2]}/${parts[1]}/${parts[0].slice(-2)}`; };
      const isMediaColumn = (h) => ['F2','COTIZACION','COT','COTIZACIÓN','TIMEOUT','TIME OUT','LAYOUT','TIMELINE'].includes(String(h).toUpperCase());

      return { isLoggedIn, loginPass, loginUser, loggingIn, doLogin, logout, currentUser, currentView, config, staffTracker, searchQuery, goHome, selectDept, openStaffTracker, reloadStaffTracker, goBackToDept, saveRow, addNewRow, openModule, filteredStaff, getTrafficStyle, ppcData, isSubmitting, selectedResponsables, staffSearch, filteredDirectory, addResponsable, promptExtraData, confirmAddToQueue, activityQueue, submitBatch, pageTitle, openFileDialog, handleFileSelect, fileInput, isUploadingFile, uploadSuccess, closeIframe, showExtraModal, extraData, priorityOpts, riskOpts, salesStaff, cellFileInput, openCellUpload, handleCellFile, toIsoDate, updateDateFromPicker, formatDisplayDate, isMediaColumn, getColumnStyle, getHeaderLabel, isCol, deptStats, currentDeptData, currentModuleId, currentDept, ppcExistingData, dynamicPpc, saveDynamicPPC, getFechaRespuestaStyle };
    }
  });

  app.config.errorHandler = (err) => { console.error(err); Swal.fire({ icon: 'error', title: 'Error de Renderizado', text: 'Ocurrió un error visual: ' + err.message }); };
  app.mount('#app');
</script>
</body>
</html>
